This code demonstrates how to create and use the [NMDP MAC
file](https://hml.nmdp.org/MacUI/) in the form of a SQLite3 database.  By
compressing the subtypes in the database, it is possible to have a database
that is less than half the size of the NMDP text file.

# About the NMDP file

The [**C.W. Bill Young Cell Transplantation
Program**](https://bloodstemcell.hrsa.gov/) provides support to patients who
need a potentially life-saving bone marrow transplant or umbilical cord blood
transplant.  Within this program, the [**National Marrow Donor
Program**](https://www.nmdp.org) works "to recruit potential marrow donors and
cord blood units, list them on a single, searchable electronic system and
facilitate the distribution of donated cord blood units and adult bone marrow
that are suitably matched to patients."

One of the NMDP's tasks is to "Facilitate tissue typing and infectious disease
marker testing of adult bone marrow donors and cord blood units".  As part of
that, they reelase the list of MACs (Multiple Allele Codes).

The list of MACs is provided as a TSV file, and is over 500 MiB in size.  This
can be annoying when you potentially need to work with multiple MACs; you
either need to search through the file multiple times (once for each MAC), or
you need to parse the entire file into memory (which takes memory).

At some point, it becomes better to read the file into some form of database,
and that is what this code does!

## Why Compressed?

The size difference, between compressed and not-compressed, is remarkable: On a
test performed with the August 13, 2024 NMDP file, the uncompressed database
was 638521344 bytes (608.9 MiB); the compressed database was 226025472 bytes (215.6 MiB).  That is a 2.8x difference in size.

# Database Structure

## Type and Header

This demo works with a SQLite3 database.  Here is what you need to know about
the database and its schema.

The database uses the "DELETE" journal-mode.  That means the database can be
shipped as a single file.  If you make any changes, once you commit, all SQLite
temporary (journal) files will be deleted.  This journal-mode makes it easy to
detect that the database was closed properly.

SQLite databases have two pieces of metadata that programs can set: The
Application ID (`PRAGMA application_id`) and the User Version (`PRAGMA
user_version`).  Both are 32-bit signed integers, and although they can be used
for anything, their names imply what they should be used for.

The Application ID is set to a specific value; other database users can check
this value, to ensure they are opening a NMDP SQLite3 database.


The User Version is used here to represent the version of the database schema.
If the User Version is not what you expect, you should not use the database.

This program has an Application ID of **1346653518** and a User Version of
**3**.  The Application ID was generated by this Python code:

```
import struct
print(struct.unpack('i', struct.pack('=cccc', b'N', b'M', b'D', b'P'))[0])
```

## Schema

The database has two tables: `Files` and `Codes`.

All strings in the database will be ASCII strings, though they are stored in
the database as Unicode strings.

The **Files** table has this definition:

```
CREATE TABLE Files(
  path     TEXT    PRIMARY KEY,
  modified TEXT,
  comment  TEXT
);
```

Each file in the NMDP zip file has a matching row in this table.  At this time,
there must be only one row.

* **path** is the path of the file within the NMDP zip file.  At this time, it
  must be `alpha.v3.txt`.

* **modified** is the last-modified date, as pulled from the zip file metadata,
  endoed as an ISO-format date-time string, with no time zone.  For example,
  the August 13, 2024 NMDP file's `modified` value is `2024-08-13T16:32:52`.

* **comment** contains the first line of the NMDP text file, with the ending
  newline removed.  For example, the August 13, 2024 NMDP file's `comment`
  value is `"LAST UPDATED: 08/13/24"`.

The **Codes** table has this definition:

```
CREATE TABLE Codes(
  code               TEXT  PRIMARY KEY,
  subtype_compressed BLOB
);
```

Each row of this table matches a row from the NMDP text file.

* **code** is the contents of the `CODE` column of the NMDP text file.

* **subtype_compressed** is the contents of the `SUBTYPE` column of the NMDP
  file, after being Zlib-compressed.  The contents of this column must be
  decompressed after reading, but before returning to the client.  Python's
  built-in [zlib](https://docs.python.org/3/library/zlib.html) package, and the
  R [zlib](https://cran.r-project.org/web/packages/zlib/index.html) package
  from CRAN, can be used for decompression (and for compression, if you plan on
  updating the database).

# The Demo

## Installing

This demo is meant to run within a Python venv, that is hosted in the Git
working directory.  You need to use Python 3.12 or later, and install the
Python requests package.

Assuming you have Python 3.12 already installed, here is what to do.

Start with a terminal shell, located in the root of the GitHub clone (where
this README file is located).

Run these commands:

```
python3.12 -m venv .
. bin/activate
python -m pip install --upgrade pip
python -m pip install --upgrade requests
```

(If you have a newer version of Python installed, use that version, instead of
`python3.12`.)

You should now be ready to run!

## Running

To run

```
. bin/activate
./demo.py nmdp.sqlite
```

First, the program will create the database (if none exists), and then open it.
Then, the program will downloda the NMDP zip file.  The list of files is
checked, and compared against what is in the database.  If the file's
last-modified time (as recorded in the zip file) matches what is in the
database, *and* the first row of the file (the "comment" row) matches what is
in the database, then no update is required, and the program exits.

A temporary file is used to store the zip file on disk, which should be cleaned
up automatically.  The temporary file is stored in whatever place the OS tells
us is the right place to store temproary files.

If the database needs to change, the database is updated to match the file's
contents.

At the end; the number of codes added, changed, and deleted is printed.  Since
it's extremely unusual for a code to be changed or deleted, when this happens,
the subtypes are printed.

# Copyright & License

The NMDP SQLite3 Demo is Â© 2024 The Board of Trustess of the Leland Stanford
Junior University.

The NMDP SQLite3 Demo is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by the Free
Software Foundation, either version 3 of the License, or (at your option) any
later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.

The full text of the license is available in the `LICENSE` file, which is at
the root of this repository.  It is also available at [https://www.gnu.org/licenses/](https://www.gnu.org/licenses/).
